# Advanced search

Query syntax[^1]

Database table[^2]

Type filtering[^5]

Ignore indexing[^6]

Ignore search[^7]

[^1]: # Query syntax

    ## Overview

    Global search  <kbd>Ctrl</kbd>+<kbd>P</kbd> supports advanced search through query syntax, in order to implement some logical operations, such as the query syntax that contains the keyword `foo` and does not contain the keyword `bar` is `foo NOT bar`.

    Before using the query syntax, let's have a general understanding of its composition:

    - String: composed of letters, numbers, etc.
    - Phrase: composed of strings
    - Query: composed of phrases, multiple queries can be combined into a new query through `AND`, `OR` and `NOT`

    Below we introduce their details respectively.

    ## Strings

    Strings can be specified in two ways:

    - Characters enclosed in English double quotes `"`. If `"` itself needs to be used, it can be escaped by SQL-style (plus a `"`), for example `"foo""bar"""` will hits `foo "bar"`
    - Consists of non `AND`, `OR` and `NOT` characters, and these characters must be:

      - All non-ASCII characters, or
      - Belongs to 52 uppercase and lowercase English characters (`A-Za-z`), or
      - Belongs to 10 ASCII numeric characters (`0-9`), or
      - Is an underscore `_`, or
      - Is the replacement character (ASCII 26)

    For strings that are not composed of other characters mentioned above, they must be wrapped with `"`, such as strings containing `-`, `*` and other symbols.

    ## Phrases

    Phrases consist of strings, which can be concatenated by `+`. A phrase is composed of some tokens in order, and these tokens are processed by the user's input text through the tokenizer. The tokenizer used by SiYuan is to make Chinese search easy to use (supports single-word search), so the implementation is based on word segmentation, which means that each Chinese character or English letter will be split into a token. This has some effect on `+` concatenation, so it is recommended not to use `+` to combine multiple phrases if unsure.

    ## Queries

    A query consists of multiple phrases, which can be combined into a new query by the operators `AND`, `OR`, and `NOT`.

    |Operator|Function|
    | ----------| -----------------------------------------------------|
    |`<query1> AND <query2>`|Matches if both query1 and query2 match|
    |`<query1> OR <query2>`|Matches if either query1 or query2 match|
    |`<query1> NOT <query2>`|Matches if query1 matches and query2 does not match|

    Use parentheses `()` to combine query priorities, for example:

    ```sql
    -- Matches documents that contain at least one instance of either "one" or "two", but do not contain any instances of token "three".
    'one OR two NOT three'

    -- Match all documents that contain the token "two" but not "three", or contain the token "one".
    'one OR (two NOT three)'
    ```
    Multiple phrases separated by spaces use `AND` by default, for example:

    ```sql
    'one two three'         -- 'one AND two AND three'
    'three "one two"'       -- 'three AND "one two"'
    'NEAR(one two) three'   -- 'NEAR(one two) AND three'
    'one OR two three'      -- 'one OR two AND three'

    '(one OR two) three'    -- Syntax error!
    'func(one two)'         -- Syntax error!
    ```
    ## Technical implementation

    We implement global search through [SQLite FTS5](https://www.sqlite.org/fts5.html).

    The key part of the query statement generated by the system is roughly `MATCH '{content name alias memo}:" + query`, `query` is the user input part, for [column filter](https://www.sqlite.org/fts5%20.html#fts5_column_filters) `{content name alias memo}:` is generated by <kbd>Settings</kbd> - <kbd>Search</kbd> - <kbd>Attribute</kbd>.

    After knowing these, we can implement the query embedding block through the query syntax, so that the query performance will be better:

    Global search  <kbd>Ctrl</kbd>+<kbd>P</kbd> supports advanced search through query syntax, in order to implement some logical operations, such as the query syntax that contains the keyword `foo` and does not contain the keyword `bar` is `foo NOT bar`.

    In addition to this, the API also supports querying using FTS.

    ### Case Sensitive

    If the <kbd>Settings</kbd> - <kbd>Search</kbd> - <kbd>Case Sensitivity</kbd> option is enabled, the search will be case-sensitive. By default, this option is disabled, that is, insensitive upper and lower case.

    Since the tokenizer is case-sensitive, we build two virtual tables to index separately:

    - `blocks_fts`: word segmentation by character
    - `blocks_fts_case_insensitive`: Convert English letters to lowercase participles

    The disadvantage of this is that it increases disk space usage and reduces indexing performance, but there is currently no better solution, so it can only be done first. In addition, diacritics are not supported, only supported case insensitive.

    If you have a better implementation, please let us know, thank you very much.


[^2]: # Database table

    ## Table `blocks`

    This table is used to store content block data.

    |Field|Description|
    | ----------: | --------------------------------------------------------------------------------|
    |id|Content block ID|
    |parent_id|Parent block ID, If the content block is a document block, this field is empty|
    |root_id|Root block ID, which is the document block ID|
    |hash|Summary checksum of the content|
    |box|Notebook ID|
    |path|The path of the document where the content block is located|
    |hpath|The path to the document where the human-readable content block is located|
    |name|Content block name|
    |alias|Content block alias|
    |memo|Content block memo|
    |content|Text with Markdown markers removed|
    |fcontent|The first child block text with Markdown markers removed|
    |markdown|Text with complete Markdown markers|
    |length|Length of `fcontent`​|
    |type|Content block type, please refer to here[^3]|
    |subtype|Content block subtype, please refer to here[^4]|
    |ial|Inline attributes list, like  `{: name="value"}`​|
    |sort|For sorting, the smaller the value, the higher the sort|
    |created|Create time, for example `20221013202001`​|
    |updated|Update time, for example `20221013202001`​|

    ## Default values

    - If `LIMIT` is not specified, only the first 64 results will be returned at most, adjustable via <kbd>Settings</kbd> - <kbd>Search</kbd> - <kbd>The number of search results displayed</kbd>
    - ​`sort` field

      - Heading block: `5`​
      - Paragraph block: `10`​
      - Code block: `10`​
      - Mathematical formula block: `10`​
      - Table block: `10`​
      - HTML block: `10`​
      - List block: `20`​
      - List item block: `20`​
      - Blockquote block: `20`​
      - Super block: `30`​
      - Database block: `30`​
      - Document block: `0`​


[^3]: ## Type field `type`

    - ​`d` Document block (Only search on the document name, will not search for the document containing content blocks)
    - ​`h` Heading block (Search only on the heading name, not the content blocks below the heading block)
    - ​`l` List block (including ordered list block, unordered list block and task list block)
    - ​`i` List item block
    - ​`b` Blockquote block
    - ​`s` Super block
    - ​`p` Paragraph block
    - ​`c` Code block
    - ​`m` Formula block
    - ​`t` Table block
    - ​`av` Database block
    - ​`query_embed` Embed block
    - ​`video` Video block
    - ​`audio` Audio block
    - ​`widget` Widget block
    - ​`iframe` IFrame block
    - ​`html` HTML block
    - ​`tb` Thematic break


[^4]: ## Subtype field `subtype`

    List block / List item block subtypes:

    - `o`：Ordered
    - `u`：Unordered
    - `t`：Task

    Heading subtypes:

    - `h1`: Level 1
    - `h2`: Level 2
    - `h3`: Level 3
    - `h4`: Level 4
    - `h5`: Level 5
    - `h6`: Level 6

    Other types of content blocks have no subtypes.


[^5]: # Type filtering

    ## Type field `type`

    - ​`d` Document block (Only search on the document name, will not search for the document containing content blocks)
    - ​`h` Heading block (Search only on the heading name, not the content blocks below the heading block)
    - ​`l` List block (including ordered list block, unordered list block and task list block)
    - ​`i` List item block
    - ​`b` Blockquote block
    - ​`s` Super block
    - ​`p` Paragraph block
    - ​`c` Code block
    - ​`m` Formula block
    - ​`t` Table block
    - ​`av` Database block
    - ​`query_embed` Embed block
    - ​`video` Video block
    - ​`audio` Audio block
    - ​`widget` Widget block
    - ​`iframe` IFrame block
    - ​`html` HTML block
    - ​`tb` Thematic break

    ## Subtype field `subtype`

    List block / List item block subtypes:

    - `o`：Ordered
    - `u`：Unordered
    - `t`：Task

    Heading subtypes:

    - `h1`: Level 1
    - `h2`: Level 2
    - `h3`: Level 3
    - `h4`: Level 4
    - `h5`: Level 5
    - `h6`: Level 6

    Other types of content blocks have no subtypes.


[^6]: # Ignore indexing

    ## Overview

    Ignore indexing means not indexing document data into the database, making the data completely unsearchable and reducing database size.

    ## How to use

    Manually create or edit the `workspace/data/.siyuan/indexignore` text file on the file system, where each line serves as an ignore path and supports gitignore syntax. For example:

    ```
    20210808180117-6v0mkxr/20200923234011-ieuun1p.sy
    20210808180117-6v0mkxr/**/*
    ```
    - ​`20210808180117-6v0mkxr/20200923234011-ieuun1p.sy`: Ignore indexing the 20200923234011-ieuun1p.sy document under the data/20210808180117-6v0mkxr notebook
    - ​`20210808180117-6v0mkxr/**/*`: Ignore indexing all documents under the data/20210808180117-6v0mkxr notebook

    You need to manually rebuild the index after modifying the configuration file.


[^7]: # Ignore search

    ## Overview

    Ignoring searches refers to filtering out certain unwanted results when searching.

    ## How to use

    Ignoring global search and ignoring reference search need to be configured separately:

    - Ignore global search: manually create or edit the `workspace/data/.siyuan/searchignore` text file on the file system
    - Ignore reference search: manually create or edit the `workspace/data/.siyuan/refsearchignore` text file on the file system

    Each line in these ignore configuration files will be used as a condition for SQL path NOT LIKE, for example:

    ```
    path NOT LIKE '/20210808180117-6v0mkxr%'
    box != '20210808180117-czj9bvb'
    id != '20200923234011-ieuun1p'
    ```
    - ​`path NOT LIKE '/20210808180117-6v0mkxr%'`: Ignore content block searches where the document path begins with ​/20210808180117-6v0mkxr
    - ​`box != '20210808180117-czj9bvb'`: Ignore content block searches under the notebook data/20210808180117-czj9bvb
    - ​`id != '20200923234011-ieuun1p'`: Ignore content block searches with id ​20200923234011-ieuun1p

    It will take 30 seconds to take effect after modifying the configuration file.
